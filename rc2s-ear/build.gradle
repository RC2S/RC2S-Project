import org.apache.tools.ant.taskdefs.condition.Os
apply plugin: 'ear'

dependencies {
    deploy project(':rc2s-ejb')
    //deploy project(':rc2s-application')
    //deploy project(':rc2s-dao')
    add ('earlib', project(path: ':rc2s-ejb', configuration: 'compile')) {
        exclude group: 'fish.payara.extras', module: 'payara-embedded-all'
        //exclude module: 'rc2s-application'
        //exclude module: 'rc2s-dao'
    }
    //earlib project(path: ':rc2s-dao', configuration: 'compile')
    // To-Do : Reussir Ã  exclude dao et application de earlib et ajouter deploy dao application
}

ear {
    appDirName 'META-INF/'
    libDirName 'APP-INF/lib'
    deploymentDescriptor {
        applicationName = "RC2S Server"
        initializeInOrder = true
        displayName = "RC2S Server"
        description = "JEE Server for RC2S project"
        module("APP-INF/lib/rc2s-application-1.0.jar", "ejb")
        module("APP-INF/lib/rc2s-dao-1.0.jar", "ejb")
    }
	
	if(!project.hasProperty('skipAutodeploy')) {
		doLast {
			tasks.autodeploy.execute();
		}
	}
}

task autodeploy(type: Exec) {
	if(Os.isFamily(Os.FAMILY_WINDOWS)) {
		executable "D:\\Programmes\\payara41\\bin\\asadmin.bat"
	}
	else {
		executable "/home/esp010/Bureau/payara41/bin/asadmin"
	}
	args "deploy", "--force=true", "--type", "ear", "--name", "rc2s", "$buildDir/libs/rc2s-ear-${version}.ear"
}